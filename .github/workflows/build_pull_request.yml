name: Build Pull Request

on:
  pull_request:
    branches:
      - "**"
  issue_comment:
    types: [created]

jobs:
  handle-comment:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request && 
      (
        github.event.comment.body == '/run' ||
        github.event.comment.body == ' /run' ||
        github.event.comment.body == '/run ' ||
        github.event.comment.body == ' /run '
      )
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Add reaction to original comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: 'eyes'
          
      - name: Extract PR information
        id: extract-pr
        run: |
          PR_URL="${{ github.event.issue.pull_request.url }}"
          
          PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL")
          
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.head.ref')
          HEAD_REPO_FULL_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.full_name')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          
          echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head-repo=$HEAD_REPO_FULL_NAME" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Update original comment - Starting build
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚è≥ Starting build process...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚è≥ I'll update this message as the build progresses.
            
            [Click here for reload comment if not update after build APK](https://github.com/${{ github.repository }}/pull/${{ steps.extract-pr.outputs.pr-number }}#issuecomment-${{ github.event.comment.id }})
            
            ---
            *Current step:* Initializing build environment...
            
      - name: Update original comment - Building
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** üîÑ Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚è≥ Checking out code and setting up build environment...
            
            [Click here for reload comment if not update after build APK](https://github.com/${{ github.repository }}/pull/${{ steps.extract-pr.outputs.pr-number }}#issuecomment-${{ github.event.comment.id }})
            
            ---
            *Current step:* Checking out PR branch...
            
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ steps.extract-pr.outputs.head-repo }}
          ref: ${{ steps.extract-pr.outputs.head-ref }}
          
      - name: Update original comment - Setting up environment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚öôÔ∏è Setting up build environment...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ Code checked out successfully
            
            **Current setup:**
            - ‚úÖ Code checkout completed
            - ‚è≥ Setting up Java JDK 21
            - ‚è≥ Setting up Gradle build system
            - ‚è≥ Generating Android debug keystore
            
            [Click here for reload comment if not update after build APK](https://github.com/${{ github.repository }}/pull/${{ steps.extract-pr.outputs.pr-number }}#issuecomment-${{ github.event.comment.id }})
            
            ---
            *Current step:* Configuring Java and Gradle...
            
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: "temurin"
          
      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true
          cache-cleanup: on-success
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Update original comment - Generating keystore
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** üîë Generating debug keystore...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ Environment set up:
            - ‚úÖ Java JDK 21
            - ‚úÖ Gradle configured
            - ‚úÖ Build permissions set
            
            **Current task:** Generating Android debug keystore...
            
            [Click here for reload comment if not update after build APK](https://github.com/${{ github.repository }}/pull/${{ steps.extract-pr.outputs.pr-number }}#issuecomment-${{ github.event.comment.id }})
            
            ---
            *Current step:* Creating debug signing key...

      - name: Generate debug.keystore if not exists
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi
          
      - name: Update original comment - Building APK
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** üèóÔ∏è Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ All setup complete:
            - ‚úÖ Java JDK 21
            - ‚úÖ Gradle  
            - ‚úÖ Debug keystore
            
            **Now building:** Universal Debug APK...
            
            [Click here for reload comment if not update after build APK](https://github.com/${{ github.repository }}/pull/${{ steps.extract-pr.outputs.pr-number }}#issuecomment-${{ github.event.comment.id }})
            
            ---
            *Current step:* Running Gradle build and lint check...

      - name: Build and Lint Universal Debug APK
        id: build-apk
        continue-on-error: true
        run: |
          # Create temporary file to store complete log
          BUILD_LOG=$(mktemp)
          
          # Run gradle build and save all output to file
          set +e
          ./gradlew --console=plain assembleUniversalDebug :app:lintUniversalDebug --warning-mode summary 2>&1 | tee "$BUILD_LOG"
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Read full build log
          FULL_LOG=$(cat "$BUILD_LOG")
          
          # Limit log to avoid exceeding output variable size (approx 0.5MB)
          # About 30000 lines or 500000 characters
          TRIMMED_LOG=$(echo "$FULL_LOG" | tail -30000 | head -c 500000)
          
          # Escape special characters for JSON/Markdown
          ESCAPED_LOG=$(echo "$TRIMMED_LOG" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e "s/'/\\'/g" -e 's/\$/\$/g')
          
          # Save trimmed log to output
          echo "build-log<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get last 50 lines for summary
          LAST_50_LINES=$(tail -50 "$BUILD_LOG")
          ESCAPED_LAST_50=$(echo "$LAST_50_LINES" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e 's/\$/\$/g')
          
          echo "build-output<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_LAST_50" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get first error lines for quick display
          ERROR_LINES=$(grep -i "error\|fail\|exception\|failed" "$BUILD_LOG" | head -10)
          if [ -z "$ERROR_LINES" ]; then
            ERROR_LINES="No specific error messages found. Check the full build log."
          fi
          ESCAPED_ERRORS=$(echo "$ERROR_LINES" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e 's/\$/\$/g')
          
          echo "error-lines<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check exit code and set build-success accordingly
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "build-success=true" >> $GITHUB_OUTPUT
            echo "Build successful!"
          else
            echo "build-success=false" >> $GITHUB_OUTPUT
            echo "Build failed with exit code: $BUILD_EXIT_CODE"
          fi
          
          # Clean up temporary file
          rm -f "$BUILD_LOG"
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST: "true"
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}
          
      - name: Process build result and update comment
        id: process-result
        run: |
          if [ "${{ steps.build-apk.outputs.build-success }}" = "true" ]; then
            echo "Build was successful"
            echo "is-success=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed"
            echo "is-success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Update original comment - Build successful
        if: steps.process-result.outputs.is-success == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚úÖ **BUILD SUCCESSFUL!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ All steps completed successfully:
            - ‚úÖ Java JDK 21
            - ‚úÖ Gradle build system  
            - ‚úÖ Debug keystore
            - ‚úÖ APK compilation
            - ‚úÖ Lint check
            
            **Current task:** Uploading APK artifact...
            
            ---
            *Current step:* Uploading artifact to GitHub Actions...

      - name: Update original comment - Build failed
        if: steps.process-result.outputs.is-success == 'false'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚ùå **BUILD FAILED!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚ùå Build failed during APK compilation
            
            **üî• First errors found:**
            ```bash
            ${{ steps.build-apk.outputs.error-lines }}
            ```
            
            <details>
            <summary>üìã Log Summary (Last 50 lines)</summary>
            
            ```bash
            ${{ steps.build-apk.outputs.build-output }}
            ```
            
            </details>
            
            <details>
            <summary>üìã Full Build Log (Trimmed)</summary>
            
            ```bash
            ${{ steps.build-apk.outputs.build-log }}
            ```
            
            </details>
            
            üîç **Debug tips:**
            1. Check for syntax errors in your code
            2. Verify all dependencies are correctly defined
            3. Ensure API keys and secrets are properly set
            
            üìä **Complete logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Note: Log has been trimmed if it was too long. Check the Actions tab for complete logs.*

      - name: Upload APK
        if: steps.process-result.outputs.is-success == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}-run
          path: app/build/outputs/apk/universal/debug/*.apk
          
      - name: Get artifact information
        if: steps.process-result.outputs.is-success == 'true'
        id: artifact-info
        run: |
          # Get artifact information from GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$ARTIFACTS_URL")
          
          echo "Artifacts response: $ARTIFACTS_JSON"
          
          # Find artifacts with matching names.
          ARTIFACT_NAME="app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}-run"
          ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id")
          
          if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "null" ]; then
            echo "Found artifact ID: $ARTIFACT_ID"
            echo "artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
            
            # Create a direct download URL
            ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
            echo "artifact-url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not find artifact ID for '$ARTIFACT_NAME'"
            echo "artifact-id=0" >> $GITHUB_OUTPUT
            echo "artifact-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" >> $GITHUB_OUTPUT
          fi
          
          # Get the current timestamp
          CURRENT_TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "timestamp=$CURRENT_TIMESTAMP" >> $GITHUB_OUTPUT
          
      - name: Update original comment - APK uploaded (Final Success)
        if: steps.process-result.outputs.is-success == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          body: |
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚úÖ **BUILD COMPLETE!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            üéâ **Build successful!** APK is ready for download.
            
            ### üì• Download APK:
            **Artifact name:** `app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}-run`
            
            [üì¶ Download APK from Actions Artifacts](${{ steps.artifact-info.outputs.artifact-url }})
            
            ### üîß Build Details:
            - **JDK:** 21 (Temurin)
            - **Build Type:** Universal Debug
            - **Keystore:** Debug keystore (auto-generated)
            - **Timestamp:** ${{ steps.artifact-info.outputs.timestamp }}
            
            ### üìã Next Steps:
            1. Download the APK above
            2. Install on Android device/emulator
            3. Test the changes
            4. Report any issues in the PR
            
            ---
            *‚úÖ This build was triggered by the \`/run\` command from @${{ github.event.comment.user.login }}.*

      - name: Update reaction on original comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          edit-mode: replace
          reactions: |
            ${{ steps.process-result.outputs.is-success == 'true' && '+1' || '-1' }}
          
      - name: Fail job if build failed
        if: steps.process-result.outputs.is-success == 'false'
        run: |
          echo "‚ùå Build failed. Marking workflow as failed."
          echo "Check the comment above for detailed error logs."
          exit 1

  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: "temurin"

      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate debug.keystore if not exists
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build and Lint Universal Debug APK
        run: ./gradlew --console=plain assembleUniversalDebug :app:lintUniversalDebug --warning-mode summary
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST: "true"
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      - name: Upload APK
        uses: actions/upload-artifact@v6
        with:
          name: app-universal-debug-pr-${{ github.event.number }}
          path: app/build/outputs/apk/universal/debug/*.apk
