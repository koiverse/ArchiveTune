name: Build Pull Request

on:
  pull_request:
    branches:
      - "**"
  issue_comment:
    types: [created]

jobs:
  handle-comment:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/run')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Extract PR information
        id: extract-pr
        run: |
          PR_URL="${{ github.event.issue.pull_request.url }}"
          
          PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL")
          
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.head.ref')
          HEAD_REPO_FULL_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.full_name')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          
          echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head-repo=$HEAD_REPO_FULL_NAME" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Create initial comment
        id: create-comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.extract-pr.outputs.pr-number }}
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚è≥ Starting build process...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            I'll update this message as the build progresses.
            
      - name: Update comment - Building
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** üîÑ Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚è≥ Checking out code and setting up build environment...
            
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ steps.extract-pr.outputs.head-repo }}
          ref: ${{ steps.extract-pr.outputs.head-ref }}
          
      - name: Update comment - Setting up environment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚öôÔ∏è Setting up build environment...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ Code checked out successfully
            
            Now setting up:
            - Java JDK 21
            - Gradle build system
            - Android debug keystore
            
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: "temurin"
          
      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true
          cache-cleanup: on-success
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Update comment - Generating keystore
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** üîë Generating debug keystore...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            ‚úÖ Environment set up:
            - Java JDK 21 ‚úì
            - Gradle ‚úì
            
            Now generating Android debug keystore...

      - name: Generate debug.keystore if not exists
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi
          
      - name: Update comment - Starting APK build
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** üèóÔ∏è Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            **Console:**
            ```bash
            Starting build process...
            ```
            
            ‚úÖ All setup complete:
            - Java JDK 21 ‚úì
            - Gradle ‚úì  
            - Debug keystore ‚úì

      - name: Build APK with live output capture
        id: build-apk
        env:
          COMMENT_ID: ${{ steps.create-comment.outputs.comment-id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ steps.extract-pr.outputs.pr-number }}
          HEAD_REF: ${{ steps.extract-pr.outputs.head-ref }}
          USER_LOGIN: ${{ github.event.comment.user.login }}
        run: |
          # Function to update comment with console output
          update_comment_with_logs() {
            local logs="$1"
            local status="$2"
            
            # Escape JSON special characters
            logs="${logs//$'\n'/\\n}"
            logs="${logs//\"/\\\"}"
            
            # Create JSON payload
            local json_payload=$(cat <<EOF
            {
              "body": "@$USER_LOGIN \n\nüöÄ **Build triggered via /run command!**\n\n**Status:** üèóÔ∏è Building APK...\n**PR:** #$PR_NUMBER\n**Branch:** \\\`$HEAD_REF\\\`\n**Triggered by:** @$USER_LOGIN\n\n**Console:**\n\`\`\`bash\n$logs\n\`\`\`\n\n‚úÖ All setup complete:\n- Java JDK 21 ‚úì\n- Gradle ‚úì  \n- Debug keystore ‚úì"
            }
            EOF
            )
            
            # Update comment via GitHub API
            curl -s -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPOSITORY/issues/comments/$COMMENT_ID" \
              -d "$json_payload"
          }
          
          # Create named pipe for build output
          mkfifo build_output.pipe
          
          # Start build in background and pipe output
          {
            ./gradlew --console=plain assembleUniversalDebug :app:lintUniversalDebug --warning-mode summary 2>&1
            echo $? > build_exit_code.txt
          } | tee build_output.pipe > build_full_output.log &
          
          BUILD_PID=$!
          
          # Buffer to accumulate logs
          LOG_BUFFER="Starting Gradle build...\n"
          LAST_UPDATE=$(date +%s)
          UPDATE_INTERVAL=10  # Update every 10 seconds
          
          # Read from pipe and update comment periodically
          while read -r line; do
            # Add line to buffer (limit to last 30 lines)
            LOG_BUFFER="${LOG_BUFFER}${line}\n"
            LOG_LINES=$(echo -e "$LOG_BUFFER" | wc -l)
            
            if [ $LOG_LINES -gt 30 ]; then
              LOG_BUFFER=$(echo -e "$LOG_BUFFER" | tail -n 30)
            fi
            
            # Update comment if interval has passed
            CURRENT_TIME=$(date +%s)
            if [ $((CURRENT_TIME - LAST_UPDATE)) -ge $UPDATE_INTERVAL ]; then
              update_comment_with_logs "$(echo -e "$LOG_BUFFER" | tail -n 20)"
              LAST_UPDATE=$CURRENT_TIME
            fi
          done < build_output.pipe
          
          # Wait for build to complete
          wait $BUILD_PID
          
          # Get exit code
          BUILD_EXIT_CODE=$(cat build_exit_code.txt)
          
          # Get final output (last 40 lines)
          FINAL_OUTPUT=$(tail -n 40 build_full_output.log)
          
          # Clean up
          rm -f build_output.pipe build_exit_code.txt
          
          # Set outputs
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "build-success=true" >> $GITHUB_OUTPUT
            echo "final-output=$FINAL_OUTPUT" >> $GITHUB_OUTPUT
          else
            echo "build-success=false" >> $GITHUB_OUTPUT
            echo "final-output=$FINAL_OUTPUT" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST: "true"
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}
          
      - name: Update comment - Build successful
        if: steps.build-apk.outputs.build-success == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚úÖ **BUILD SUCCESSFUL!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            **Final Console Output:**
            ```bash
            ${{ steps.build-apk.outputs.final-output }}
            ```
            
            ‚úÖ All steps completed:
            - Java JDK 21 ‚úì
            - Gradle ‚úì  
            - Debug keystore ‚úì
            - APK build ‚úì
            - Lint check ‚úì
            
            üì¶ Now uploading APK artifact...
            
      - name: Update comment - Build failed
        if: steps.build-apk.outputs.build-success == 'false'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚ùå **BUILD FAILED!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            **Final Console Output:**
            ```bash
            ${{ steps.build-apk.outputs.final-output }}
            ```
            
            ‚ùå Build failed during APK compilation
            
            Check the Actions tab for complete logs.

      - name: Upload APK
        if: steps.build-apk.outputs.build-success == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}-run
          path: app/build/outputs/apk/universal/debug/*.apk
          
      - name: Update comment - APK uploaded (Final)
        if: steps.build-apk.outputs.build-success == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.create-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            @${{ github.event.comment.user.login }} 
            
            üöÄ **Build triggered via /run command!**
            
            **Status:** ‚úÖ **BUILD COMPLETE!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            **Triggered by:** @${{ github.event.comment.user.login }}
            
            **Final Build Output:**
            ```bash
            ${{ steps.build-apk.outputs.final-output }}
            ```
            
            üéâ **Build successful!** APK is ready for download.
            
            ### üì• Download APK:
            **Artifact name:** \`app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}-run\`
            
            [Download APK from Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            
            ### üîß Build Details:
            - **JDK:** 21 (Temurin)
            - **Build Type:** Universal Debug
            - **Keystore:** Debug keystore (auto-generated)
            - **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### üìã Next Steps:
            1. Download the APK above
            2. Install on Android device/emulator
            3. Test the changes
            4. Report any issues in the PR
            
            ---
            *This build was triggered by the \`/run\` command.*
            
      - name: Add reaction to original comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: 'rocket'

  # Original PR build job (runs on regular PR events)
  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: "temurin"

      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate debug.keystore if not exists
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build and Lint Universal Debug APK
        run: ./gradlew --console=plain assembleUniversalDebug :app:lintUniversalDebug --warning-mode summary
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST: "true"
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      - name: Upload APK
        uses: actions/upload-artifact@v6
        with:
          name: app-universal-debug-pr-${{ github.event.number }}
          path: app/build/outputs/apk/universal/debug/*.apk
