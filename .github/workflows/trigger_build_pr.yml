name: Trigger Build on Comment

on:
  issue_comment:
    types: [created]

jobs:
  trigger-build:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '/run') || contains(github.event.comment.body, '/remove-trigger'))
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      actions: write  # Need this to trigger workflows
    
    steps:
      - name: Extract PR information
        id: extract-pr
        run: |
          # Get PR info from the webhook payload
          PR_URL="${{ github.event.issue.pull_request.url }}"
          
          # Fetch detailed PR info using GitHub API
          PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$PR_URL")
          
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.head.ref')
          HEAD_REPO_FULL_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.full_name')
          BASE_REF=$(echo "$PR_JSON" | jq -r '.base.ref')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          
          echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head-repo=$HEAD_REPO_FULL_NAME" >> $GITHUB_OUTPUT
          echo "base-ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Determine action
        id: determine-action
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" == *"/remove-trigger"* ]]; then
            echo "action=remove-trigger" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == *"/run"* ]]; then
            echo "action=run-build" >> $GITHUB_OUTPUT
          fi
          
      - name: Handle /run command - Trigger workflow_dispatch
        if: steps.determine-action.outputs.action == 'run-build'
        run: |
          # Trigger the build workflow manually
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/build_pull_request.yml/dispatches" \
            -d '{
              "ref": "main",
              "inputs": {
                "pr_number": "'"${{ steps.extract-pr.outputs.pr-number }}"'",
                "branch_name": "'"${{ steps.extract-pr.outputs.head-ref }}"'"
              }
            }'
          
          echo "Build workflow triggered via workflow_dispatch"
          
      - name: Handle /run command - Wait for workflow to start
        if: steps.determine-action.outputs.action == 'run-build'
        id: wait-for-workflow
        run: |
          # Wait for the workflow to appear in runs
          PR_NUMBER="${{ steps.extract-pr.outputs.pr-number }}"
          REPO="${{ github.repository }}"
          MAX_WAIT=60
          WAIT_INTERVAL=5
          total_wait=0
          
          echo "Waiting for build workflow to start..."
          
          while [ $total_wait -lt $MAX_WAIT ]; do
            # Check for workflow runs
            RUNS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/runs?event=workflow_dispatch")
            
            # Check if our triggered run exists
            TRIGGERED=$(echo "$RUNS_JSON" | jq -r --arg pr "$PR_NUMBER" '
              .workflow_runs[] | 
              select(.display_title | contains($pr)) |
              .id' | head -1)
            
            if [ -n "$TRIGGERED" ]; then
              echo "Found workflow run: $TRIGGERED"
              echo "workflow-run-id=$TRIGGERED" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "Waiting $WAIT_INTERVAL seconds for workflow to start..."
            sleep $WAIT_INTERVAL
            total_wait=$((total_wait + WAIT_INTERVAL))
          done
          
      - name: Handle /run command - Monitor build
        if: steps.determine-action.outputs.action == 'run-build' && steps.wait-for-workflow.outputs.workflow-run-id
        id: monitor-build
        run: |
          RUN_ID="${{ steps.wait-for-workflow.outputs.workflow-run-id }}"
          REPO="${{ github.repository }}"
          MAX_WAIT=600  # 10 minutes
          WAIT_INTERVAL=10
          total_wait=0
          
          echo "Monitoring build run: $RUN_ID"
          
          while [ $total_wait -lt $MAX_WAIT ]; do
            # Get run status
            RUN_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")
            
            STATUS=$(echo "$RUN_JSON" | jq -r '.status')
            CONCLUSION=$(echo "$RUN_JSON" | jq -r '.conclusion')
            
            echo "Build status: $STATUS, conclusion: $CONCLUSION"
            
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "Build completed successfully!"
                echo "build-result=success" >> $GITHUB_OUTPUT
                
                # Get artifact info
                ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/artifacts")
                
                ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[0].id // empty')
                if [ -n "$ARTIFACT_ID" ]; then
                  echo "artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
                fi
                break
              else
                echo "Build failed with conclusion: $CONCLUSION"
                echo "build-result=failure" >> $GITHUB_OUTPUT
                break
              fi
            fi
            
            sleep $WAIT_INTERVAL
            total_wait=$((total_wait + WAIT_INTERVAL))
          done
          
          if [ $total_wait -ge $MAX_WAIT ]; then
            echo "Timeout waiting for build completion"
            echo "build-result=timeout" >> $GITHUB_OUTPUT
          fi
          
      - name: Handle /remove-trigger command
        if: steps.determine-action.outputs.action == 'remove-trigger'
        run: |
          # Checkout the PR branch to remove the workflow file
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # We need to checkout the specific branch
          git fetch origin ${{ steps.extract-pr.outputs.head-ref }}:${{ steps.extract-pr.outputs.head-ref }}
          git checkout ${{ steps.extract-pr.outputs.head-ref }}
          
          if [ ! -f .github/workflows/trigger_build_pr.yml ]; then
            echo "already-removed=true" >> $GITHUB_ENV
          else
            rm -f .github/workflows/trigger_build_pr.yml
            echo "already-removed=false" >> $GITHUB_ENV
            
            git add .github/workflows/trigger_build_pr.yml
            git commit -m "Remove trigger workflow via /remove-trigger command [by @${{ github.event.comment.user.login }}]"
            git push origin ${{ steps.extract-pr.outputs.head-ref }}
          fi
          
      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: '+1'
          
      - name: Add comment response for /run
        if: steps.determine-action.outputs.action == 'run-build'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.extract-pr.outputs.pr-number }}
          body: |
            @${{ github.event.comment.user.login }} 
            
            ${{ steps.monitor-build.outputs.build-result == 'success' && '‚úÖ **Build completed successfully!**' || '' }}
            ${{ steps.monitor-build.outputs.build-result == 'failure' && '‚ùå **Build failed!** Check the Actions tab for details.' || '' }}
            ${{ steps.monitor-build.outputs.build-result == 'timeout' && '‚è±Ô∏è **Build timeout!** The build took too long to complete.' || '' }}
            ${{ !steps.monitor-build.outputs.build-result && 'üîÑ **Build triggered!** The build workflow has been started...' || '' }}
            
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            
            ${{ steps.monitor-build.outputs.build-result == 'success' && '**APK Download:** [Download APK](https://github.com/' || '' }}${{ steps.monitor-build.outputs.build-result == 'success' && github.repository || '' }}${{ steps.monitor-build.outputs.build-result == 'success' && '/actions/runs/' || '' }}${{ steps.monitor-build.outputs.build-result == 'success' && steps.wait-for-workflow.outputs.workflow-run-id || '' }}${{ steps.monitor-build.outputs.build-result == 'success' && '/artifacts)' || '' }}
            
            **Build Details:** [View Build](https://github.com/${{ github.repository }}/actions/runs/${{ steps.wait-for-workflow.outputs.workflow-run-id }})
            
      - name: Add removal comment for /remove-trigger
        if: steps.determine-action.outputs.action == 'remove-trigger'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.extract-pr.outputs.pr-number }}
          body: |
            @${{ github.event.comment.user.login }} 
            
            ${{ env.already-removed == 'true' && 'The trigger workflow file was already removed from this PR branch.' || '‚úÖ The trigger workflow has been successfully removed from this PR branch.' }}
            
            **PR Branch:** \`${{ steps.extract-pr.outputs.head-ref }}\`
            ${{ env.already-removed == 'false' && '**File removed:** `.github/workflows/trigger_build_pr.yml`' || '' }}
            
            **Note:** This removal only affects this PR branch. The workflow file remains in the main repository.
